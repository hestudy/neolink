# Story 1.2: 数据库设计与连接

## Status

Draft

## Story

**作为一个** 系统，
**我想要** 建立数据库连接和基础 schema，
**以便** 能够持久化存储书签数据。

## Acceptance Criteria

1. PostgreSQL 数据库已配置，包含 pgvector 扩展
2. Drizzle ORM 已集成，支持类型安全的数据库操作
3. 书签表(bookmarks)已创建，包含所有必要字段（id, url, title, description, created_at 等）
4. 数据库迁移系统已设置，支持版本控制和回滚
5. 数据库连接池已配置，支持并发访问
6. 基础的数据库种子数据已创建，用于开发和测试
7. 数据库备份脚本已实现
8. 数据库连接健康检查已实现

## Tasks / Subtasks

- [ ] 配置 PostgreSQL 数据库和 pgvector 扩展 (AC: 1)
  - [ ] 更新 Docker Compose 配置使用 pgvector/pgvector:pg15 镜像
  - [ ] 创建数据库初始化脚本启用 pgvector 扩展
  - [ ] 验证 pgvector 扩展正确安装和配置

- [ ] 完善 Drizzle ORM 集成 (AC: 2)
  - [ ] 更新 packages/database 的依赖配置
  - [ ] 创建 Drizzle 配置文件 (drizzle.config.ts)
  - [ ] 设置 Drizzle Kit 用于迁移管理
  - [ ] 配置类型安全的数据库连接

- [ ] 设计和创建书签表 schema (AC: 3)
  - [ ] 基于架构文档设计完整的 bookmarks 表结构
  - [ ] 实现 users 表（为书签关联做准备）
  - [ ] 创建 tags 表和 bookmark_tags 关联表
  - [ ] 添加 pgvector 字段用于语义搜索
  - [ ] 设置适当的索引和约束

- [ ] 实现数据库迁移系统 (AC: 4)
  - [ ] 创建初始迁移文件
  - [ ] 设置迁移脚本和命令
  - [ ] 实现迁移回滚功能
  - [ ] 创建迁移状态跟踪

- [ ] 配置数据库连接池 (AC: 5)
  - [ ] 优化连接池参数（最大连接数、超时等）
  - [ ] 实现连接池监控和日志
  - [ ] 配置环境变量管理
  - [ ] 添加连接重试机制

- [ ] 创建种子数据系统 (AC: 6)
  - [ ] 设计种子数据结构
  - [ ] 创建种子数据脚本
  - [ ] 实现开发环境数据初始化
  - [ ] 添加测试数据生成工具

- [ ] 实现数据库备份功能 (AC: 7)
  - [ ] 创建数据库备份脚本
  - [ ] 设置定时备份任务
  - [ ] 实现备份文件管理
  - [ ] 添加备份恢复功能

- [ ] 增强数据库健康检查 (AC: 8)
  - [ ] 扩展现有健康检查功能
  - [ ] 添加连接池状态检查
  - [ ] 实现数据库性能监控
  - [ ] 集成到 API 健康检查端点

## Dev Notes

### 前一个故事的重要见解

[Source: docs/stories/1.1.project-infrastructure.md#Dev Agent Record]

- 项目已建立完整的 Monorepo 结构，packages/database 目录已存在
- Docker 环境已配置，包含 PostgreSQL 和 Redis 服务
- 基础的数据库连接已在 packages/database/src/connection.ts 中实现
- 当前使用 postgres:15-alpine 镜像，需要升级到 pgvector/pgvector:pg15

### 数据模型规范

[Source: docs/architecture.md#数据模型]

**Bookmark 实体结构：**

```typescript
interface Bookmark {
  id: string;
  url: string;
  title: string;
  description?: string;
  content?: string;
  summary?: string;
  favicon?: string;
  screenshot?: string;
  tags: string[];
  aiTags: string[];
  manualTags: string[];
  notes?: string;
  isArchived: boolean;
  isDeleted: boolean;
  processingStatus: ProcessingStatus;
  embedding?: number[];
  createdAt: Date;
  updatedAt: Date;
  userId: string;
}
```

**User 实体结构：**

```typescript
interface User {
  id: string;
  email: string;
  name?: string;
  preferences: UserPreferences;
  aiSettings: AISettings;
  createdAt: Date;
  lastLoginAt?: Date;
}
```

**Tag 实体结构：**

```typescript
interface Tag {
  id: string;
  name: string;
  color?: string;
  description?: string;
  isAiGenerated: boolean;
  usageCount: number;
  createdAt: Date;
  userId: string;
}
```

### 技术栈要求

[Source: docs/architecture.md#技术概览]

- **数据库**: PostgreSQL 15+ with pgvector 扩展
- **ORM**: Drizzle ORM v0.29.0+ 用于类型安全操作
- **连接**: node-postgres (pg) 连接池
- **迁移**: Drizzle Kit 用于 schema 管理

### 数据库配置要求

[Source: docs/architecture.md#容器化架构]

- **镜像**: pgvector/pgvector:pg15（支持向量搜索）
- **连接池**: 最大 20 个连接，30 秒空闲超时
- **健康检查**: pg_isready 命令，30 秒间隔
- **数据持久化**: 本地卷挂载 /var/lib/postgresql/data

### 文件位置规范

[Source: docs/architecture.md#仓库结构]

- **Schema 定义**: packages/database/src/schema.ts
- **连接配置**: packages/database/src/connection.ts
- **迁移文件**: packages/database/migrations/
- **种子数据**: packages/database/seeds/
- **Drizzle 配置**: packages/database/drizzle.config.ts

### 环境变量配置

[Source: .env.example]

```
DATABASE_URL=postgresql://neolink:neolink_password@localhost:5432/neolink
POSTGRES_DB=neolink
POSTGRES_USER=neolink
POSTGRES_PASSWORD=neolink_password
```

### Testing

#### 测试框架和工具

[Source: docs/architecture.md#测试策略]

- **测试工具**: Vitest + Testing Library
- **数据库测试**: 使用测试数据库实例
- **覆盖率要求**: 数据库操作 >95%

#### 测试文件位置

- 单元测试：packages/database/src/\*.test.ts
- 集成测试：packages/database/tests/integration/
- 迁移测试：packages/database/tests/migrations/

#### 测试标准

- 所有 schema 定义必须有验证测试
- 数据库连接和连接池必须有集成测试
- 迁移脚本必须有前向和回滚测试
- 种子数据脚本必须有验证测试

## Change Log

| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-01-16 | 1.0     | 初始故事创建，基于 Epic 1.2 | Bob    |

## Dev Agent Record

_此部分将由开发代理在实施过程中填充_

### Agent Model Used

_待填充_

### Debug Log References

_待填充_

### Completion Notes List

_待填充_

### File List

_待填充_

## QA Results

_此部分将由 QA 代理在审查完成的实施后填充_
